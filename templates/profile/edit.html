
{% extends 'layouts/base.html' %}

{% block head %}
  <link href="/static/css/profile.css" rel="stylesheet">
  <script>
    window.TRANSLATIONS = {
      uploading: "{{ _('Uploading...') }}",
      progress: "{{ _('Progress') }}",
      uploaded: "{{ _('Uploaded!') }}",
      error_uploading: "{{ _('Error during download') }}"
    };
  </script>
  <script src="/static/js/profile.js" defer></script>
{% endblock %}

{% set title %}
  {{ _('User profile') }} {{ username }}
{% endset %}

{% block title %}
  {{ title }}
{% endblock %}

{% block mobile_title %}
<h4 style="padding-left: 0.6rem; padding-top: 0.35rem;">{{ username }}</h4>
{% endblock %}

{% block content %}
  <div class="container container-box neon-border">

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert" id="flash-message">
          {{ messages[0] }}
        </div>
        <script>
          setTimeout(() => {
            const msg = document.getElementById('flash-message');
            if (msg) msg.remove();
          }, 3000);
        </script>
      {% endif %}
    {% endwith %}

    <h2 class="d-none d-md-block">{{ title }}</h2>

    {% if user[5] == 1 %}
      <div class="verified-box">✅ {{ _('Verified') }}</div>
    {% endif %}

    <form method="POST" action="/update_profile" enctype="multipart/form-data">
      <input type="hidden" name="visible" value="1">

      <div class="row">
        <div class="col-md-3 text-center">
<div class="avatar-upload text-center">
  <label for="avatarInput" class="avatar-preview-label">
    <img id="avatarPreview" src="/{{ user[4] or 'static/images/Sample_User_Icon.png' }}" class="avatar-preview neon-border">
  </label>
  <input type="file" id="avatarInput" name="avatar" accept="image/*" hidden>
</div>
        </div>

        <div class="col-md-9">
          <label class="form-label">{{ _('Description') }}:</label>
          <textarea name="description" class="form-control" maxlength="300">{{ user[6] or '' }}</textarea>

          <label class="form-label mt-3">{{ _('Category:') }}</label>
          <select name="category" id="category" class="form-control" required onchange="toggleCityField()">
            <option value="0" {% if user[7] == 0 %}selected{% endif %}>{{ _("Don't show") }}</option>
            <option value="1" {% if user[7] == 1 %}selected{% endif %}>{{ _('Virtual Models') }}</option>
            <option value="2" {% if user[7] == 2 %}selected{% endif %}>{{ _('Escorts') }}</option>
          </select>

          <div id="cityField" class="mt-3" style="display: none;">
            <label class="form-label">{{ _('City (for individuals):') }}</label>
            <select name="city" class="form-control">
              {% for city in [
                'Kyiv', 'Lviv', 'Kharkiv', 'Odesa', 'Dnipro',
                'Zaporizhzhia', 'Ivano-Frankivsk', 'Ternopil',
                'Chernivtsi', 'Uzhhorod', 'Poltava', 'Chernihiv',
                'Zhytomyr', 'Khmelnytskyi', 'Lutsk', 'Vinnytsia'
              ] %}
                <option value="{{ city }}" {% if user[8] == city %}selected{% endif %}>{{ _(city) }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn btn-custom mt-3">
            <span class="icon"></span> {{ _('Save changes') }}
          </button>
        </div>
      </div>
    </form>

    <p></p>

    <a href="/messages" class="btn btn-custom mb-2 position-relative">
      {{ _('Messages') }}
      {% if unread_count > 0 %}
        <span class="badge-unread">{{ unread_count }}</span>
      {% endif %}
    </a>
    <a href="/new_post" class="btn btn-custom mb-2 position-relative">
      {{ _('New post') }}
    </a>
    <a href="/blog/{{ user[0] }}" class="btn btn-custom mb-2 position-relative">
      {{ _('Blog') }}
    </a>

    {# Gallery section #}
    <h4 class="mt-4">{{ _('Gallery') }}</h4>

    {% if photos %}
      <div class="gallery-scroll mb-3">
        {% for filename in photos %}
          <div class="media-item">
            {% set ext = filename.split('.')[-1].lower() %}
            {% if ext in ['jpg', 'jpeg', 'png'] %}
              <img src="{{ url_for('serve_upload', filename='media/' ~ username ~ '/' ~ filename) }}">
            {% elif ext in ['mp4', 'webm'] %}
              <video controls>
                <source src="{{ url_for('serve_upload', filename='media/' ~ username ~ '/' ~ filename) }}">
              </video>
            {% endif %}
            <form action="/delete_photo" method="POST">
              <input type="hidden" name="filename" value="{{ filename }}">
              <button class="btn btn-custom mt-2">{{ _('Delete') }}</button>
            </form>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {# Upload form #}
    <form id="uploadForm" action="/upload_media" method="POST" enctype="multipart/form-data">
      <label>{{ _('Upload media:') }}</label>

      <div id="previewContainer" class="preview-container mt-3"></div>

      <div class="upload-controls">
        <div class="custom-file-upload">
          <label for="mediaInput" class="btn btn-custom">
            <span class="icon"></span>
          </label>
          <input type="file" id="mediaInput" name="media_files" accept="image/*,video/*" multiple hidden required>
          <span id="fileNames" class="file-names mt-2"></span>
        </div>
        <button class="btn btn-custom" type="submit">{{ _('Upload') }}</button>
      </div>

      <div id="progressContainer" style="display: none;" class="mt-3">
        <div class="neon-progress-bar">
          <div class="neon-progress-fill" id="progressFill"></div>
        </div>
        <div id="progressText" class="mt-1" style="font-size: 14px; color: var(--text-color);">
          {{ _('Uploading...') }}
        </div>
      </div>
    </form>

    <h4 class="mt-4">{{ _('Products') }}</h4>

    <a href="/add_product" class="btn btn-custom mb-2">
      <span class="icon"></span> {{ _('Add product') }}
    </a>

    {% if products %}
      <div class="d-flex flex-wrap gap-3">
        {% for product in products %}
          <div class="product-card">
            <img src="{{ url_for('serve_upload', filename='products/' + username + '/' + product[4]) }}">
            <p><strong>{{ product[1] }}</strong></p>
            <p><small>{{ product[2] }}</small></p>
            <div>{{ product[3] }} {{ product[5] }}</div>
            {% if session['username'] == username %}
              <form method="POST" action="/delete_product">
                <input type="hidden" name="product_id" value="{{ product[0] }}">
                <button class="btn btn-custom mt-1">{{ _('Delete') }}</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

  </div>
{% endblock %}

